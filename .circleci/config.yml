version: 2.1


jobs:  
  deployment-and-api-tests:    
    build: # name of your job
    machine: # executor type
      image: ubuntu-2004:202010-01
    steps:   
      - checkout  
      - run:
          name: 'Test Scheduler Build Block API'
          command:
            'echo testing all examples in /examples against test suite in /test'     
      - run:
          name: Deploy Mock APP for Scheduler BB API and PyTest Containers
          command: cd examples/mock && docker-compose up --build -d
      - run:
          name: Check Status of Mock App and API Testing Containers
          command: docker ps
      - run:
          name: Testing Scheduler BB API 
          command: 'echo testing using conatainers' 
      - run:
          name: Check Status of Testing Containers are Deployed 
          command: docker ps
      - run:
          name: Testing Scheduler BB API 
          command: 'echo testing using conatainers' 
      
      - run:
          name: Run cucumber tests against Register BB Mock 
          command: docker  exec -i pytest  curl -X GET http://myapi:3000/event/list_details
          
      - run:
          name: Create test-results directory
          command: mkdir /home/circleci/project/test-results
      - run:
          name: Run cucumber tests against Register BB Mock 
          command: docker  exec -i pytest  pytest -k smoke  -s --json-report --json-report-indent=4 --json-report-file=/test-results/smoke_testing_report.json && ls -la /home/circleci/project/test-results
                
      - run:
          name: Copy test results to host machine
          command: docker cp pytest:/test-results /tmp
      - store_test_results:
          path: /tmp/test-results
      - store_artifacts:
          path: /tmp/test-results

workflows:  
  deployment-and-api-tests:    
    jobs:      
      - deployment-and-api-tests:
          filters:            
            branches:
              only:
                - main
